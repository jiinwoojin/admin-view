<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" layout:decorator="layout/page-layout">
<th:block layout:fragment="content-title-fragment">
    <h1 class="h3 mb-0 text-gray-800">
        SEED 설정</h1>
</th:block>

<th:block layout:fragment="content-breadcrumb-fragment">
    <nav aria-label="breadcrumb" class="col-md-12 px-2">
        <h2 class="page_tit">SEED 설정</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a th:href="@{/view/proxy/setting}">서비스 캐시 관리</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">SEED 설정</li>
        </ol>
    </nav>
</th:block>

<th:block layout:fragment="content-body-fragment">
    <div class="row">
        <div class="col-xl-4">
            <h3 class="section_tit">Seed 생성</h3>
            <form id="seed-create" accept-charset="utf-8" onsubmit="return preSubmit(this);" enctype="multipart/form-data">
                <div class="form-group row">
                    <div class="col-12">
                        <label>SEED 인덱스(Dokcer 이름)</label>
                    </div>
                    <div class="col-12 input-group">
                        <input type="text" class="form-control" disabled th:value="${ seedName + '-자동생성(인덱스)'} ">
                    </div>
                    <div class="col-12">
                        <small class="form-text text-muted">자동생성 됩니다.</small>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-6">
                        <label>캐시 데이터 선택</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <input id="cache-select" type="text" class="form-control" name="cache" value="world_cache" readonly />
                                <div class="input-group-append">
                                    <button class="btn btn-info" type="button" data-toggle="modal" data-target="#searchProxyCache">
                                        <i class="fas fa-search" data-toggle="tooltip" title="CACHE 선택"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <label>기준 범위 이름</label>
                        <input type="text" class="form-control" name="coverage" value="korea">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-6">
                        <label>ZOOM 레벨 시작</label>
                        <select type="text" class="form-control" name="levelFrom">
                            <option th:each="v : ${ #numbers.sequence(1, 19) }" th:value="${v}" th:text="${v}" th:selected="${ v == 11 }" />
                        </select>
                    </div>
                    <div class="col-6">
                        <label>ZOOM 레벨 종료</label>
                        <select type="text" class="form-control" name="levelTo">
                            <option th:each="v : ${ #numbers.sequence(1, 19) }" th:value="${v}" th:text="${v}" th:selected="${ v == 14 }" />
                        </select>
                    </div>
                </div>

                <div class="input-group my-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text">타일 갱신 기준</span>
                    </div>
                    <input style="height: 38px;" type="text" class="form-control text-right" name="refreshBefore" value="1" />
                    <select class="form-control" name="refreshBeforeType">
                        <option value="weeks">주 (WEEKS)</option>
                        <option value="days">일 (days)</option>
                        <option value="hours" selected="selected">시간 (hours)</option>
                        <option value="minutes">분 (minutes)</option>
                    </select>
                </div>

                <div class="input-group my-2">
                    <div class="input-group-prepend">
                        <span class="input-group-text">타일 소멸 기준</span>
                    </div>
                    <input style="height: 38px;" type="text" class="form-control text-right" name="removeBefore" value="1" />
                    <select class="form-control" name="removeBeforeType">
                        <option value="weeks">주 (WEEKS)</option>
                        <option value="days">일 (days)</option>
                        <option value="hours" selected="selected">시간 (hours)</option>
                        <option value="minutes">분 (minutes)</option>
                    </select>
                </div>

                <div class="form-group row">
                    <div class="col-12">
                        <label>투영</label>
                        <select class="form-control" name="projection" onchange="onchange_seed_srs(this)">
                            <option value="epsg:4326" selected="selected">EPSG:4326</option>
                            <option value="epsg:3857">EPSG:3857</option>
                        </select>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-12">영역(위경도)</label>
                    <div class="col-3">
                        <label>Min X.</label>
                        <input type="text" class="form-control" id="minx" name="xmin" value="115">
                    </div>
                    <div class="col-3">
                        <label>Min Y.</label>
                        <input type="text" class="form-control" id="miny" name="ymin" value="30">
                    </div>
                    <div class="col-3">
                        <label>Max X.</label>
                        <input type="text" class="form-control" id="maxx" name="xmax" value="135">
                    </div>
                    <div class="col-3">
                        <label>Max Y.</label>
                        <input type="text" class="form-control" id="maxy" name="ymax" value="45">
                    </div>
                </div>
                <div class="text-right">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="fn_initialize_seed_param()">
                        <i class="fas fa-sync"></i> 초기화
                    </button>

                    <button type="button" class="btn btn-primary btn-sm" onclick="fn_seed_create()">
                        <i class="fas fa-save"></i> 추가생성
                    </button>
                </div>
            </form>
        </div>

        <div class="col-xl-8">
            <div class="row">
                <div class="col-xl-12">
                    <h3 class="section_tit">Seed 컨테이너 목록</h3>
                    <table id="list_table" class="table table-sm basic">
                        <thead class="table-info">
                        <tr>
                            <th scope="col" class="text-center nowrap">컨테이너 ID</th>
                            <th scope="col" class="text-center nowrap">이름</th>
                            <th scope="col" class="text-center nowrap">이미지</th>
                            <th scope="col" class="text-center nowrap">포트 정보</th>
                            <th scope="col" class="text-center nowrap">상태 정보</th>
                            <th scope="col" class="text-center nowrap">생성 기간</th>
                            <th scope="col" class="text-center nowrap">버튼</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="seed : ${ seedContainers }">
                            <td class="text-center align-center"
                                th:text="${ seed.id.substring(0, 15) + '...' }"
                                th:title="${ seed.id }"
                            ></td>
                            <td class="text-center align-center" th:text="${ seed.name }"></td>
                            <td class="text-center align-center" th:text="${ seed.image }"></td>
                            <td class="text-center align-center" th:text="${ seed.ports == null ? '-' : seed.ports }"></td>
                            <td class="text-center align-center" th:text="${ #strings.toUpperCase(seed.status) }"></td>
                            <td class="text-center align-center" th:text="${ #dates.format(seed.createdAt, 'yyyy-MM-dd HH:mm')  }"></td>
                            <td>
                                <button class="btn btn-warning btn-sm btn-circle mx-1" type="button" th:onclick="fn_seed_view([[${seed.name}]])" title="진행 현황 보기" data-toggle="tooltip">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button th:if="${ seed.isDefault() }" class="btn btn-success btn-sm btn-circle mx-1" type="button" th:onclick="fn_default_seed_reload()" title="기본 SEED 호출" data-toggle="tooltip">
                                    <i class="fas fa-server"></i>
                                </button>
                                <button th:unless="${ seed.isDefault() }" class="btn btn-danger btn-sm btn-circle mx-1" type="button" th:onclick="fn_seed_remove([[${seed.name}]])" title="진행 중단" data-toggle="tooltip">
                                    <i class="fas fa-stop"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <hr style="width: 100%;"/>
                <form class="col-xl-12" id="detail-form">
                    <h3 class="section_tit">Seed 진행 내역</h3>
                    <div>
                        <div class="form-group">
                            <label>Seed 이름</label>
                            <input class="form-control form-control-sm" name="seed_name" readonly />
                        </div>
                        <div class="form-group mt-2">
                            <label>진행영역</label>
                            <div class="col-12 row m-0 p-0">
                                <div class="col-4 p-0">
                                    <label>크기(MB)</label>
                                    <input class="form-control form-control-sm text-right" name="size" readonly />
                                </div>
                                <div class="col-2">
                                    <label>Min X.</label>
                                    <input class="form-control form-control-sm text-right" name="xmin" readonly />
                                </div>
                                <div class="col-2">
                                    <label>Min Y.</label>
                                    <input class="form-control form-control-sm text-right" name="ymin" readonly />
                                </div>
                                <div class="col-2">
                                    <label>Max X.</label>
                                    <input class="form-control form-control-sm text-right" name="xmax" readonly />
                                </div>
                                <div class="col-2">
                                    <label>Max Y.</label>
                                    <input class="form-control form-control-sm text-right" name="ymax" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3">
                                <label>경과 시간</label>
                                <input class="form-control form-control-sm text-right" name="time" readonly />
                            </div>
                            <div class="col-3">
                                <label>진행 중인 ZOOM 레벨</label>
                                <input class="form-control form-control-sm text-right" name="level" readonly />
                            </div>
                            <div class="col-3">
                                <label>진행도 (%)</label>
                                <input class="form-control form-control-sm text-right" name="per" readonly />
                            </div>
                            <div class="col-3">
                                <label>처리된 타일 수</label>
                                <input class="form-control form-control-sm text-right" name="tile_count" readonly />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="searchProxyCache" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">CACHE 데이터 선택</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table id="list_table_caches" class="table table-sm basic my-1">
                        <thead class="table-info">
                        <tr>
                            <th scope="col" class="text-center">선택</th>
                            <th scope="col" class="text-center">이름</th>
                            <th scope="col" class="text-center">종류</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cache : ${proxyCaches}">
                            <td class="text-center">
                                <button class="btn btn-sm btn-primary btn-circle"
                                        type="button"
                                        data-toggle="tooltip"
                                        title="CACHE 설정"
                                        th:onclick="onclick_set_cache_data([[${cache.name}]])"
                                >
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            </td>
                            <td class="text-center align-middle" th:text="${ cache.name }"></td>
                            <td class="text-center align-middle" th:text="${ 'file' }"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $('#list_table').each(function () {
                initialize_dataTable(this.id, {columnDefs: [
                    { targets: 0, className: "text-center" },
                    { targets: 1, className: "text-center" },
                    { targets: 2, className: "text-center" },
                    { targets: 3, className: "text-center" },
                    { targets: 4, className: "text-center" },
                    { targets: 5, className: "text-center" },
                    { targets: 6, className: "text-center text-nowrap" },
                ]});
            })

            initialize_small_dataTable('list_table_caches');
        });
        // Map Proxy YAML 파일에 저장된 내용들을 불러온다.
        function fn_initialize_seed_param(){
            $('#cache-select').val('world_cache');
            $('input[name="coverage"]').val('korea');
            $('select[name="levelFrom"]').val('11');
            $('select[name="levelTo"]').val('14');
            $('input[name="refreshBefore"]').val(1);
            $('select[name="refreshBeforeType"]').val('hours');
            $('input[name="removeBefore"]').val(1);
            $('select[name="removeBeforeType"]').val('hours');
            $('select[name="projection"]').val('epsg:4326');
            $('#minx').val(115);
            $('#miny').val(30);
            $('#maxx').val(135);
            $('#maxy').val(45);
        }

        function fn_seed_create(){
            if(confirm("Seed를 생성하시겠습니까?")){
                $.ajax({
                    url: CONTEXT + '/view/proxy/seeding-create',
                    type: 'get',
                    data: jQuery("#seed-create").serialize(),
                    success: function(data){
                        if(!data.RESULT){
                            toastr.error("Seed 생성에 실패하였습니다.")
                        } else {
                            var seed = data.RESULT;
                            var table = $('#list_table').DataTable();
                            table.row.add([
                                seed.id.substring(0, 15) + "...",
                                seed.name,
                                seed.image,
                                seed.ports !== '' ? seed.ports : '-',
                                seed.status,
                                getTimeStamp(),
                                '<button class="btn btn-success btn-sm btn-circle mx-1" type="button" onclick="fn_seed_view(\''+seed.name+'\')" title="진행 현황 보기"><i class="fas fa-eye"></i></button>' +
                                '<button class="btn btn-danger btn-sm btn-circle mx-1" type="button" onclick="fn_seed_remove(\''+seed.name+'\')" title="진행 중단"><i class="fas fa-stop"></i></button>'
                            ]).draw( false );
                            toastr.success("Seed 생성에 성공하였습니다.");
                        }
                    },
                    error: function(e){
                        toastr.error("Seed 생성에 실패하였습니다.");
                        console.error(e);
                    }
                });
            }
        }
        function fn_seed_remove(seedName){
            if(confirm("Seed를 제거하시겠습니까?")){
                $.ajax({
                    url: CONTEXT + '/view/proxy/seeding-stop',
                    type: 'get',
                    data: { SEEDNAME : seedName },
                    success: function(data){
                        if(data.RESULT === 'FAILURE'){
                            toastr.error("Seed 제거에 실패하였습니다.")
                        } else {
                            var table = $('#list_table').DataTable();
                            var datas = table.data()
                            jQuery.each(datas, function(idx, item){
                                if(seedName == new String(item[1])){
                                    table.row(idx).remove().draw( false )
                                }
                            });
                            toastr.success("Seed 제거에 성공하였습니다.")
                        }
                    },
                    error: function(e){
                        console.error(e)
                        toastr.error("Seed 제거에 실패하였습니다.")
                    }
                });
            }
        }

        function fn_default_seed_reload(){
            if(confirm("기본 Seed를 재시작 하시겠습니까?")){
                $.ajax({
                    url: CONTEXT + '/view/proxy/default-seeding-reload',
                    type: 'get',
                    success: function(data){
                        if (data.RESULT == '') {
                            toastr.error("Seed 재시작에 실패하였습니다.");
                        } else {
                            toastr.success("Seed 재시작에 성공하였습니다.");
                        }
                    },
                    error: function(e){
                        console.error(e);
                        toastr.error("Seed 재시작에 실패하였습니다.");
                    }
                });
            }
        }

        function fn_seed_view(seedName){
            $.ajax({
                url: CONTEXT + '/view/proxy/seeding-info',
                type: 'get',
                data: { SEEDNAME : seedName },
                success: function(data){
                    console.log(data)
                    var form = document.getElementById("detail-form");
                    form.seed_name.value = seedName
                    form.size.value = (data.DIR_SIZE / 1024 / 1024).toFixed(2)
                    form.xmin.value = data.LOGS.XMIN.replace(",","")
                    form.ymin.value = data.LOGS.YMIN.replace(",","")
                    form.xmax.value = data.LOGS.XMAX.replace(",","")
                    form.ymax.value = data.LOGS.YMAX.replace(",","")
                    form.level.value = data.LOGS.LEVEL
                    form.time.value = data.RunningFor
                    form.per.value = data.LOGS.PER
                    form.tile_count.value = data.LOGS.TILES_CNT.replace("(","")
                },
                error: function(e){
                    console.error(e)
                }
            });
        }

        function getTimeStamp() {
            var d = new Date();
            var s =
                leadingZeros(d.getFullYear(), 4) + '-' +
                leadingZeros(d.getMonth() + 1, 2) + '-' +
                leadingZeros(d.getDate(), 2) + ' ' +

                leadingZeros(d.getHours(), 2) + ':' +
                leadingZeros(d.getMinutes(), 2);

            return s;
        }

        function leadingZeros(n, digits) {
            var zero = '';
            n = n.toString();

            if (n.length < digits) {
                for (i = 0; i < digits - n.length; i++) {
                    zero += '0';
                }
            }
            return zero + n;
        }

        function onchange_seed_srs(dom) {
            var srs = dom.value;
            var minx = $('#minx').val();
            var miny = $('#miny').val();
            var maxx = $('#maxx').val();
            var maxy = $('#maxy').val();

            var p1 = [0, 0], p2 = [0, 0];
            if (srs === 'epsg:3857') {
                p1 = [-20026376.39, -20048966.10];
                p2 = [20026376.39, 20048966.10];
                if (!isNaN(minx) && !isNaN(miny) && !isNaN(maxx) && !isNaN(maxy)) {
                    p1 = jiCommon.convert.wgs84ToMercator(minx, miny);
                    p2 = jiCommon.convert.wgs84ToMercator(maxx, maxy);
                }
            }
            if (srs === 'epsg:4326') {
                p1 = [-180, -90];
                p2 = [180, 90];
                if (!isNaN(minx) && !isNaN(miny) && !isNaN(maxx) && !isNaN(maxy)) {
                    p1 = jiCommon.convert.mercatorToWgs84(minx, miny);
                    p2 = jiCommon.convert.mercatorToWgs84(maxx, maxy);
                }
            }

            $('#minx').val(Math.round(p1[0]));
            $('#miny').val(Math.round(p1[1]));
            $('#maxx').val(Math.round(p2[0]));
            $('#maxy').val(Math.round(p2[1]));
        }

        function onclick_set_cache_data(cache) {
            $('#cache-select').val(cache);
            $('#searchProxyCache').modal('toggle');
        }
    </script>
</th:block>

<th:block layout:fragment="custom-html-link">
    <link rel="stylesheet" th:href="@{/design-park/resource/library/css/plugins/dataTables/datatables.min.css}">
    <link rel="stylesheet" th:href="@{/design-park/resource/library/js/plugins/jquery-ui/jquery-ui.min.css}">
</th:block>

<th:block layout:fragment="custom-html-script">
    <script th:src="@{/design-park/resource/library/js/plugins/dataTables/datatables.min.js}"></script>
    <script th:src="@{/design-park/resource/library/js/plugins/dataTables/dataTables.bootstrap4.min.js}"></script>
    <script th:src="@{/design-park/resource/library/js/plugins/jquery-ui/jquery-ui.min.js}"></script>
</th:block>
</html>
