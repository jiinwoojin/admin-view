<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" layout:decorator="layout/page-layout">

<head>
    <link rel="stylesheet" th:href="@{/css/symbol/symbol-bootstrap.css}">
    <link rel="stylesheet" th:href="@{/css/symbol/symbol.css}">
</head>

<th:block layout:fragment="content-title-fragment">
    <h1 class="h3 mb-0 text-gray-800">공통 지도</h1>
</th:block>

<th:block layout:fragment="content-breadcrumb-fragment">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="#">지도 도시</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">공통 지도</li>
        </ol>
    </nav>
</th:block>

<th:block layout:fragment="content-body-fragment">
    <div id="map_block">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link map-item" id="pills-display2d" style="cursor: pointer;">
                    <i class="fas fa-vector-square"></i> 2차원
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link  map-item" id="pills-display3d" style="cursor: pointer;">
                    <i class="fas fa-cube"></i> 3차원
                </a>
            </li>
        </ul>

        <div class="sample-div" style="position: absolute;"></div>
        <div class="tab-content" id="mapContent" style="width: 100%; height: 65vh;"></div>

        <div class="d-flex justify-content-between my-1">
            <div id="military-position">
                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#layer_modal" data-backdrop="false">
                    <i class="fas fa-layer-group"></i> 레이어
                </button>
                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#shape_modal" data-backdrop="false">
                    <i class="fas fa-vector-square"></i> 투명도
                </button>
                <button type="button" class="btn btn-sm btn-info" id="click_coord_btn">
                    <i class="fas fa-fighter-jet"></i> 군대부호
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="layer_modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">레이어 목록</h4>
                </div>
                <div class="modal-body">
                    <div class="pt-1 pb-1">
                        <table id="list_table" class="table table-sm table-striped">
                            <thead class="table-info">
                            <tr>
                                <th scope="col" class="text-center">레이어 이름</th>
                                <th scope="col" class="text-center">레이어 ON / OFF</th>
                            </tr>
                            </thead>
                            <tbody id="layerContent">
                            <tr>
                                <td class="text-center align-middle">
                                    레이어 A
                                </td>
                                <td class="text-center align-middle">
                                    <fieldset id="layer0">
                                        <input class="opacity form-control-range" type="range" min="0" max="1" step="0.01" />
                                        <input type="checkbox" class="visible" id="visible0" />
                                        <label for="visible0"> 보이기</label>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center align-middle">
                                    레이어 B
                                </td>
                                <td class="text-center align-middle">
                                    <fieldset id="layer1">
                                        <input class="opacity form-control-range" type="range" min="0" max="1" step="0.01" />
                                        <input type="checkbox" class="visible" id="visible1" />
                                        <label for="visible1"> 보이기</label>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center align-middle">
                                    레이어 C
                                </td>
                                <td class="text-center align-middle">
                                    <fieldset id="layer2">
                                        <input class="opacity form-control-range" type="range" min="0" max="1" step="0.01" />
                                        <input type="checkbox" class="visible" id="visible2" />
                                        <label for="visible2"> 보이기</label>
                                    </fieldset>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal">
                        <i class="fas fa-times"></i> 닫기
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
    </div>

    <div class="modal fade" id="shape_modal" style="width: 60%; height: auto;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">투명도 추가</h4>
                </div>
                <div class="modal-body">
                    <th:block th:replace="fragments/overlay/html-overlay-main" />
                </div>
                <div class="modal-footer">
                    <button type="button" id="overlay_start" class="btn btn-sm btn-primary">
                        <i class="fas fa-save"></i> 편집 시작
                    </button>
                    <button type="button" id="overlay_move" class="btn btn-sm btn-primary">
                        <i class="fas fa-save"></i> 지도 이동
                    </button>
                    <button type="button" id="overlay_save" class="btn btn-sm btn-primary">
                        <i class="fas fa-save"></i> 저장
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal">
                        <i class="fas fa-times"></i> 닫기
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
    </div>

    <th:block th:replace="fragments/military/html-military-prop"/>
    <th:block th:replace="fragments/military/html-military-main"/>

    <script>
        function modal_draggable(id){
            $(id).draggable({
                handle: ".modal-header"
            });
        }

        let overlayModal = '#shape_modal';
        let layerModal = '#layer_modal';

        var sampleDiv = document.querySelector('.sample-div');
        var mapContent = document.querySelector('#mapContent');

        let d3Canvas = null;
        let comAttr = type_common;
        let options = {
            h: '100%',
            w: '100%',
            addTo: '.sample-div',
            addBorderRect: true
        };

        $(window).ready(function() {
            modal_draggable('#layer_modal');
            modal_draggable('#shape_modal');
            modal_draggable('#military_modal');

            $('.btn-overlay').tooltip();

            $('#list_table').DataTable({
                "language" : {
                    "lengthMenu" : "페이지 단위 : _MENU_ 건",
                    "zeroRecords" : "해당 자료가 존재하지 않습니다.",
                    "info" : "_PAGES_ 페이지 중 _PAGE_ 페이지 / 총 _MAX_ 건",
                    "infoEmpty" : "해당 자료가 존재하지 않습니다.",
                    "infoFiltered" : "(총 _TOTAL_ 건)",
                    "search" : "검색 키워드 : ",
                    "paginate": {
                        "first" : "<<",
                        "last" : ">>",
                        "next" : ">",
                        "previous" : "<"
                    }
                }
            });

            if (stmp.getMilsym() === undefined) {
                stmp.setMilSym(ms);
            }

            getMap('mapbox-display');
            $('#pills-display2d').addClass('active');
            stmp.PRESENT_MAP_KIND = stmp.MAP_KIND.MAP_2D;

            $(overlayModal).on('hide.bs.modal', function() {
                if (stmp.drawMode) {
                    stmp.drawMode = false;

                    sampleDiv.style.setProperty('pointer-events', 'none');
                    mapContent.style.removeProperty('pointer-events');

                    stmp.d3Canvas.closeCanvas();
                }
            });

            $(layerModal).on('show.bs.modal', setLayer);

            $('.map-item').click(function(e) {
                if (this.id) {
                    let _id = this.id;

                    let contentName;

                    stmp.mapObject.getExtents();

                    if (_id === 'pills-display2d') {
                        contentName = 'mapbox-display';
                        $('#pills-display3d').removeClass('active');
                        $('#pills-display2d').addClass('active');
                        stmp.PRESENT_MAP_KIND = stmp.MAP_KIND.MAP_2D;
                    } else if (_id === 'pills-display3d') {
                        contentName = 'cs-display';
                        $('#pills-display2d').removeClass('active');
                        $('#pills-display3d').addClass('active');
                        stmp.PRESENT_MAP_KIND = stmp.MAP_KIND.MAP_3D;
                    }

                    if (stmp.mapObject !== null) {
                        stmp.mapObject = null;
                    }

                    getMap(contentName);
                }
            });

            $('#overlay_save').click(function() {
                console.log('save');
                debugger;
                saveCanvasData(stmp.d3Canvas);
            });

            $('#overlay_move').click(function() {
                stmp.drawMode = false;

                sampleDiv.style.setProperty('pointer-events', 'none');
                mapContent.style.removeProperty('pointer-events');

                editingMoveMap(d3Canvas);
            });

            $('#overlay_start').click(function() {
                sampleDiv.style.setProperty('z-index', 999);
                sampleDiv.style.setProperty('width', document.querySelector('#mapContent').clientWidth + 'px');
                sampleDiv.style.setProperty('height', document.querySelector('#mapContent').clientHeight + 'px');
                mapContent.style.setProperty('pointer-events', 'none');

                stmp.drawMode = true;

                if (d3Canvas === null) {    // 새로운 시작
                    d3Canvas = new SVGCanvas(options);
                    stmp.d3Canvas = d3Canvas;
                } else {                    // 편집 재시작
                    if (stmp.editingToMoveMapYn) {
                        mapMoveToEditing(stmp.d3Canvas);
                    }
                }
            });
        });

        function getMap(content) {
            let url = '/view/display/' + content;

            $('#mapContent').load(url);
        }

        function setLayer() {
            debugger;
            console.log('레이어 클릭.');
        }
    </script>

    <script th:src="@{/jquery/jquery-ui.min.js}"></script>
    <script th:src="@{/js/commons/jsHashMap.js}"></script>
    <script th:src="@{/js/commons/geoTrans.js}"></script>
    <script th:src="@{/js/commons/feature.js}"></script>
    <script th:src="@{/js/military/mb-milSymbol.js}"></script>
    <script th:src="@{/js/military/milSymbol.js}"></script>
    <script th:src="@{/js/commons/cfsiStmpCommon.js}"></script>
</th:block>
</html>